import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DeviceOrientationControls } from './libs/DeviceOrientationControls.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

document.addEventListener('click', onClick);
const triggersForObject = [];
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2(); 
let mixer;
const animationClips = [];

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setAnimationLoop(animate);
document.body.appendChild(renderer.domElement);

// Используем видео с веб-камеры как текстуру для фона сцены
navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
    const video = document.createElement('video');
    video.srcObject = stream;
    video.play();

    const videoTexture = new THREE.VideoTexture(video);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    videoTexture.format = THREE.RGBFormat;

    scene.background = videoTexture;
});

const loader = new GLTFLoader();
loader.load(
    './scene.glb',
    function (gltf) {
        scene.add(gltf.scene);
        gltf.scene.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
                if (child.name == "Mars" || child.name == "Moon") {
                    triggersForObject.push(child);
                    console.log('Trigger addings:' + child.name);
                }
            }
        });

        if (gltf.animations.length > 0) {
            mixer = new THREE.AnimationMixer(gltf.scene);
            animationClips.push(...gltf.animations);
            mixer.clipAction(animationClips[0]).play();
            mixer.clipAction(animationClips[1]).play();
            mixer.clipAction(animationClips[2]).play();
        }
    },    
    function (xhr) {
        console.log((xhr.loaded / xhr.total * 100) + '% loaded');
    },    
    function (error) {
        console.log('An error happened:' + error);
    } 
);

const light = new THREE.AmbientLight(0xffffff, 5);
scene.add(light);
let controls;

function isMobileDevice() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

if (isMobileDevice()) {
    initializeGyroControls();
} else {
    controls = new OrbitControls(camera, renderer.domElement);
    controls.maxPolarAngle = Math.PI;
    controls.minDistance = 1.0;
    controls.maxDistance = 1.0;
    controls.enableZoom = false;
    controls.target.set(0, 10, 0);
    controls.update();
}

function initializeGyroControls() {
    camera.position.set(0, 10, 0);
    controls = new DeviceOrientationControls(camera);
    window.addEventListener("deviceorientation", handleOrientation);
}

const clock = new THREE.Clock();
function animate() {
    if (controls) { controls.update(); }
    if (mixer) { mixer.update(clock.getDelta()); }
    renderer.render(scene, camera);
}

function handleOrientation(event) {
    if (controls) {
        controls.update(event.alpha, event.beta, event.gamma);
    }
}

function onClick(event) {
    if (triggersForObject.length === 0) return;

    event.preventDefault();
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(triggersForObject);

    if (intersects.length > 0) { 
        const object = intersects[0].object;
        console.log('TriggerPress: ' + object.name);
        if (object.name == "Mars") { 
            setTimeout(() => {window.location.href = 'https://ariestellar.github.io/ARSpaceDay360Mars.github.io';}, 1000);
        }

        if (object.name == "Moon") { 
            setTimeout(() => {window.location.href = 'https://ariestellar.github.io/ARSpaceDay360Moon.github.io';}, 1000);
        }
    }
}
